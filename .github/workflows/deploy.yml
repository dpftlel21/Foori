name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: EC2 ì†ŒìŠ¤ì½”ë“œ ì—…ë°ì´íŠ¸
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/Foori/foori
            git pull origin main

      - name: ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/Foori/foori
            export VITE_KAKAO_MAP_KEY=${{ secrets.VITE_KAKAO_MAP_KEY }}
            docker-compose build \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              --build-arg VITE_KAKAO_MAP_KEY=${{ secrets.VITE_KAKAO_MAP_KEY }} \
              --parallel

      - name: ì»¨í…Œì´ë„ˆ êµì²´
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker-compose down

            # 2. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            docker-compose up -d

            # 3. ë¹Œë“œ ìºì‹œ ì •ë¦¬
            echo "ğŸ§¹ ë¹Œë“œ ìºì‹œ ì •ë¦¬ ì¤‘..."
            docker builder prune -f

            # 4. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ—‘ï¸ ë¯¸ì‚¬ìš© ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f

            # 5. ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Docker ì‹œìŠ¤í…œ ìƒíƒœ:"
            docker system df

            # 6. ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "âœ… ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
            docker ps | grep foori-frontend
